(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{498:function(t,a,s){"use strict";s.r(a);var e=s(4),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[s("code",[t._v("logrotate")]),t._v("可以管理日志文件，可以根据日期切割、根据日志文件大小切割、自动删除超过一定时间的归档日志。")]),t._v(" "),s("h2",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),s("p",[t._v("测试环境为 。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CentOS Linux release 8.2.2004 (Core) \n")])])]),s("p",[t._v("其他系统类似，请先检查"),s("code",[t._v("logrotate")]),t._v("是否安装，一切以文档为准。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("man")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logrotate")]),t._v("\n")])])]),s("h2",{attrs:{id:"使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),s("p",[t._v("首先创建一个日志文件。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/log/logrotate-test\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建日志文件，并添加一些信息")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /var/log/logrotate-test/access.log\n")])])]),s("p",[t._v("创建"),s("code",[t._v("logrotate")]),t._v("配置文件，格式是这样的。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("日志文件绝对路径（可以使用通配符*） {\n\t指令1\n\t指令2\n\t...\n}\n")])])]),s("p",[s("code",[t._v("logrotate")]),t._v("全局配置文件位于"),s("code",[t._v("/etc/logrotate.conf")]),t._v("，自定义配置文件位于"),s("code",[t._v("/etc/logrotate.d/")]),t._v("。")]),t._v(" "),s("p",[t._v("一个具体的例子，表示每天切割日志，并压缩存档，最多保存5份存档（按时间排序，较早的删除），切割日志后自动创建新的日志文件，存档日志以时间为后缀。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/logrotate.d/logrotate-test\n\n/var/log/logrotate-test/access.log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tdaily\n\tcompress\n\trotate "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n\tcreate\n\tdateext\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("由于定时任务未到，需要手动通知"),s("code",[t._v("logrotate")]),t._v("执行切割任务。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logrotate")]),t._v(" -vf /etc/logrotate.d/logrotate-test\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("> ll /var/log/logrotate-test\n\ntotal 4\n-rw-r--r--. 1 root root  0 Nov 13 20:17 access.log\n-rw-r--r--. 1 root root 41 Nov 13 20:15 access.log-20201113.gz\n")])])]),s("p",[t._v("基本使用就是这样，为了验证，你可以等待几天看看切割结果。除此之外，"),s("code",[t._v("logrotate")]),t._v("还有其他指令，比如可以在每次切割后执行命令，这里往日志文件添加新的记录。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/var/log/logrotate-test/access.log {\n\tdaily\n\tcompress\n\trotate 5\n\tcreate\n\tdateext\n\tpostrotate\n        seq 10 > /var/log/logrotate-test/access.log\n    endscript\n}\n")])])]),s("h2",{attrs:{id:"logrotate-如何运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#logrotate-如何运行"}},[t._v("#")]),t._v(" Logrotate 如何运行")]),t._v(" "),s("p",[s("code",[t._v("logrotate")]),t._v("是通过 "),s("code",[t._v("cron")]),t._v("定时任务实现的。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/cron.daily/logrotate\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/sh")]),t._v("\n\n/usr/sbin/logrotate /etc/logrotate.conf\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("EXITVALUE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$?")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$EXITVALUE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    /usr/bin/logger -t "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logrotate")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ALERT exited abnormally with ['),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$EXITVALUE")]),t._v(']"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$EXITVALUE")]),t._v("\n")])])]),s("p",[t._v("每天都会执行一次"),s("code",[t._v("/usr/sbin/logrotate /etc/logrotate.conf")]),t._v("，"),s("code",[t._v("/etc/logrotate.conf")]),t._v("文件包含了"),s("code",[t._v("/etc/logrotate.d/")]),t._v("，所以所有的配置文件都会执行一遍，执行时根据具体配置决定是否切割。")]),t._v(" "),s("p",[t._v("试着手动执行一下该命令。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logrotate")]),t._v(" -v /etc/logrotate.conf\n")])])]),s("p",[t._v("在输出中显示。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("rotating pattern: /var/log/logrotate-test/access.log  after 1 days (5 rotations)\nempty log files are rotated, old logs are removed\nconsidering log /var/log/logrotate-test/access.log\n  Now: 2020-11-13 21:00\n  Last rotated at 2020-11-13 20:31\n  log does not need rotating (log has been rotated at 2020-11-13 20:31, that is not day ago yet)\n")])])]),s("p",[t._v("提示该日志文件今日已切割过，切割记录在"),s("code",[t._v("/var/lib/logrotate/logrotate.status")]),t._v("。")]),t._v(" "),s("p",[t._v("修改切割记录为两天前。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('"/var/log/logrotate-test/access.log" 2020-11-11-20:31:46\n')])])]),s("p",[t._v("再次执行命令，生成切割日志。")]),t._v(" "),s("h2",{attrs:{id:"指令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#指令"}},[t._v("#")]),t._v(" 指令")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("指令")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("missingok")]),t._v(" "),s("td",[t._v("如果日志文件不存在，不报错。")])]),t._v(" "),s("tr",[s("td",[t._v("nocreate")]),t._v(" "),s("td",[t._v("切割完日志文件后，不创建新文件。")])]),t._v(" "),s("tr",[s("td",[t._v("notifempty")]),t._v(" "),s("td",[t._v("如果日志文件为空，不切割。")])]),t._v(" "),s("tr",[s("td",[t._v("postrotate/endscript")]),t._v(" "),s("td",[t._v("执行完切割后执行的命令。")])]),t._v(" "),s("tr",[s("td",[t._v("prerotate/endscript")]),t._v(" "),s("td",[t._v("执行切割前执行的命令。")])]),t._v(" "),s("tr",[s("td",[t._v("sharedscripts")]),t._v(" "),s("td",[t._v("prerotate 和 postrotate 只执行一次")])])])])])}),[],!1,null,null,null);a.default=r.exports}}]);